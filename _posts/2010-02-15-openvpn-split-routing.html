---
layout: wordpress-import
status: publish
published: true
title: Split Routing with OpenVPN
author: Peter Murray
author_login: lyrdor
author_email: jester@dltj.org
author_url: http://dltj.org/about
wordpress_id: 1524
wordpress_url: http://dltj.org/?p=1524
date: '2010-02-15 11:47:06 -0500'
date_gmt: '2010-02-15 16:47:06 -0500'
categories:
- Raw Technology
tags:
- networking
- system administration
- openvpn
comments:
- id: 92480
  author: Sharing VPN from XP to Linux virtual - Server Fault
  author_email: ''
  author_url: ''
  date: '2010-10-10 19:06:33 -0400'
  date_gmt: '2010-10-10 23:06:33 -0400'
  content: "<!--%kramer-ref-pre%-->[...] http://dltj.org/article/openvpn-split-routing/
    [...]<!--%kramer-ref-post%-->"
- id: 94150
  author: Sharing VPN from XP to Linux virtual - efreedom
  author_email: ''
  author_url: ''
  date: '2010-10-18 19:31:34 -0400'
  date_gmt: '2010-10-18 23:31:34 -0400'
  content: "<!--%kramer-ref-pre%-->[...] http://dltj.org/article/openvpn-split-routing/
    \       Answer by Anonymous Show Additional Answers >>  Find More Answers: [...]<!--%kramer-ref-post%-->"
- id: 101868
  author: Sharing VPN from XP to Linux virtual
  author_email: ''
  author_url: http://drija.com/virtualbox/121713/sharing-vpn-from-xp-to-linux-virtual/
  date: '2010-11-22 03:25:50 -0500'
  date_gmt: '2010-11-22 08:25:50 -0500'
  content: "[...] http://dltj.org/article/openvpn-split-routing/  September 29, 2010
    7:25 am         dunxd Can you clarify what you mean by &#8220;When I turn on VPN,
    Linux has no access to it&#8221;? Do you mean the Linux box cannot access the
    VPN? Or do you mean the Linux box can no longer access the internet?  September
    29, 2010 10:19 am [...]"
- id: 183877
  author: 'OpenVPN Support Forum &bull; [Closed] how to split tunnel with OpenVPN
    : Off Topic, Related'
  author_email: ''
  author_url: http://forums.openvpn.net/topic8229.html
  date: '2011-11-09 23:28:30 -0500'
  date_gmt: '2011-11-10 04:28:30 -0500'
  content: "<!--%kramer-ref-pre%-->[...] with the other 2 VPN server&#039;s IP? I
    have seen other kinds of solutions too:topic7806.html#p11133andhttp://dltj.org/article/openvpn-split-r
    ... ier_0_1524but nothing came out. Its possible to use a batch script to split
    the traffic? Its possible that VPN [...]<!--%kramer-ref-post%-->"
- id: 247602
  author: VPN 20 Ribu Untuk Unlimited Internet Tanpa Quota - Kaskus - The Largest
    Indonesian Community
  author_email: ''
  author_url: ''
  date: '2012-05-03 01:52:11 -0400'
  date_gmt: '2012-05-03 05:52:11 -0400'
  content: "<!--%kramer-ref-pre%-->[...] -anonymously-safely.html http://dltj.org/article/openvpn-split-routing/
    \ istirahat dulu no komeng 4 kapel piu dei   View bbcode       alexispalex - Today
    04:07 AM  #3783   [...]<!--%kramer-ref-post%-->"
- id: 269419
  author: Neil
  author_email: neil.a.davis@gmail.com
  author_url: ''
  date: '2012-06-30 08:19:49 -0400'
  date_gmt: '2012-06-30 12:19:49 -0400'
  content: Thanks for this post, it helped me a lot with my learning. After a lot
    more reading I also found that there is an option 'route-nopull' that you can
    add to your OpenVPN client.conf file that will prevent the client from changing
    your default route, so then you only need to manually setup the specific routes
    you DO want to route over the VPN.
- id: 270366
  author: Peter Murray
  author_email: jester@dltj.org
  author_url: http://dltj.org/about
  date: '2012-07-02 16:04:53 -0400'
  date_gmt: '2012-07-02 20:04:53 -0400'
  content: Thanks for the reply, Neil.  I didn't know about that client configuration
    option.
- id: 289278
  author: Robert
  author_email: anon@razza.org
  author_url: ''
  date: '2012-08-14 05:35:40 -0400'
  date_gmt: '2012-08-14 09:35:40 -0400'
  content: "If you have access to the openvpn server.  Or can get the admins to make
    a change, commenting out:\r\npush \"redirect-gateway\"\r\nwould stop all clients
    of the openvpn server from getting the vpn as the default gateway.  FYI this is
    rarely the default on the server side.  So someone likely enabled it."
- id: 330621
  author: 'Is it possible to have a VPN that can access US and UK sites at the same
    time or unlimited switching? : VPN'
  author_email: ''
  author_url: http://www.reddit.com/r/VPN/comments/11qw0b/is_it_possible_to_have_a_vpn_that_can_access_us/
  date: '2012-10-20 20:13:43 -0400'
  date_gmt: '2012-10-21 00:13:43 -0400'
  content: "<!--%kramer-ref-pre%-->[...] #2: And the last step: split tunnel with
    OpenVPN: http://dltj.org/article/openvpn-split-routing/ . I might try it myself
    to start watching BBC videos, or just for [...]<!--%kramer-ref-post%-->"
- id: 339672
  author: All network traffic forced through VPN? - AnandTech Forums
  author_email: ''
  author_url: http://forums.anandtech.com/showthread.php?t=2279219
  date: '2012-10-31 12:40:40 -0400'
  date_gmt: '2012-10-31 16:40:40 -0400'
  content: "<!--%kramer-ref-pre%-->[...]  [...]<!--%kramer-ref-post%-->"
- id: 460389
  author: networking - Using native connection while still connected to a vpn - Ask
    Ubuntu
  author_email: ''
  author_url: http://askubuntu.com/questions/252560/using-native-connection-while-still-connected-to-a-vpn/252563
  date: '2013-03-08 09:24:36 -0500'
  date_gmt: '2013-03-08 14:24:36 -0500'
  content: "<!--%kramer-ref-pre%-->[...] that worked and I got my routing table. I
    also found this guide dltj.org/article/openvpn-split-routing. It shows how he
    set up split-tunnelling. &ndash;&nbsp;MaxMackie Feb 8 at [...]<!--%kramer-ref-post%-->"
- id: 526363
  author: Choosing a VPN?
  author_email: ''
  author_url: http://www.overclock.net/t/1384017/choosing-a-vpn
  date: '2013-04-20 11:33:10 -0400'
  date_gmt: '2013-04-20 15:33:10 -0400'
  content: "<!--%kramer-ref-pre%-->[...] to the VPN and leave all other traffic untouched?
    Thanks  It&#039;s possible, but difficult. See this: http://dltj.org/article/openvpn-split-routing/
    \ Reply   Reply         post #7 of 12   4/20/13 at [...]<!--%kramer-ref-post%-->"
- id: 650269
  author: networking - Connect Debian server to a VPN server and still provide services
    to the internet - Server Fault
  author_email: ''
  author_url: http://serverfault.com/questions/528156/connect-debian-server-to-a-vpn-server-and-still-provide-services-to-the-internet
  date: '2013-09-20 07:09:12 -0400'
  date_gmt: '2013-09-20 11:09:12 -0400'
  content: "<!--%kramer-ref-pre%-->[&#8230;] though the remote server instructs the
    OpenVPN client to use the tunnel for everything, you should create a route-up
    script on the client that overrides the default [&#8230;]<!--%kramer-ref-post%-->"
- id: 687343
  author: Al Tsang
  author_email: altsang@yahoo.com
  author_url: ''
  date: '2017-04-19 15:30:16 -0400'
  date_gmt: '2017-04-19 19:30:16 -0400'
  content: thank you thank you thank you thank you! great explanation!
---
<p>My place of work has installed a <acronym title="Virtual Private Network">VPN</acronym> that moderates our access to the server network using the <a href="http://en.wikipedia.org/wiki/OpenVPN" title="OpenVPN - Wikipedia, the free encyclopedia">OpenVPN protocol</a>.  This is a good thing, but in its default configuration it would send all traffic -- even that not destined for the machine room network -- through the VPN.  Since most of what I do doesn't involve servers in the machine room, I wanted to change the configuration of the OpenVPN client to only send the machine room traffic through the VPN and everything else through the (original) default gateway.  As it turns out, this involves tweaking the routing tables.<br />
<!--more--><br />
In its default configuration, the OpenVPN client establishes a default route pointing to the OpenVPN server as the gateway.  What I needed to do is remove that default route to the OpenVPN server gateway, recreate the original default route to the underlying interface's gateway, and add a new specific route for the machine room network using the OpenVPN server gateway.  These additions to the "ovpn" file were:</p>
{% highlight config %}
route-delay 2
route-up "/some/location/openvpn-default-route-reset.sh"
route 193.20.135.0/24 255.255.255.0 vpn_gateway
{% endhighlight %}
<p>The "route-delay" line forces the two subsequent changes to happen after all of the OpenVPN-driven routing changes are made.  The "route-up" line runs a shell script that deletes the OpenVPN-supplied default route and adds the one pointing back to the underlying interface's gateway.  (More on this shell script below.)  The "route" line adds the machine room specific network through the OpenVPN tunnel.  ((Note, this really isn't the machine room network of my place of work.))  (The "vpn_gateway" is a keyword in the configuration file that is replaced by the gateway address of the OpenVPN tunnel at runtime.)</p>
<p>For reasons I don't understand, I couldn't delete and re-add the default route via the OpenVPN configuration file.  Instead, I needed to create an external shell script with those commands and execute that script via the "route-up" configuration line.  The contents of the shell script are really simple:</p>
{% highlight bash %}
#!/bin/bash
/sbin/route delete default
/sbin/route add default $route_net_gateway
{% endhighlight %}
<p>OpenVPN will push a bunch of environment variables in to the subprocess, and one of them is <code>$route_net_gateway</code> that gets the "pre-existing default IP gateway in the system routing table."  That value is used in the third line to reset the default gateway.  This script gets run as root, so perform due diligence to protect the script (<abbrev title="change file access permissions">chmod</abbrev> it to "700" and <abbrev title="change file owner and group">chown</abbrev> it to "root").</p>
<p>With that in place, my network routing tables look something like this:</p>
{% highlight config %}
Internet:
Destination        Gateway            Flags        Refs      Use   Netif Expire
default            192.168.2.1        UGSc           40        0     en1
10.242.2.1/32      10.242.2.9         UGSc            0        0    tun0
10.242.2.9         10.242.2.10        UH              4        1    tun0
127                127.0.0.1          UCS             0        0     lo0
127.0.0.1          127.0.0.1          UH             12 15704029     lo0
192.168.2          link#5             UCS             2        0     en1
192.168.2.1        0:c0:49:ff:8c:c5   UHLWI          42      108     en1   1158
192.168.2.3        127.0.0.1          UHS             0        9     lo0
193.20.135         10.242.2.9         UGSc            2        0    tun0
193.20.135.2/32    192.168.2.1        UGSc            1        0     en1
{% endhighlight %}
