---
layout: wordpress-import
status: published
published: true
title: Drupal as the Foundation of Ohio Textbook Portal
modified: '2018-01-15T22:38:08-05:00'
author: Peter Murray
author_login: lyrdor
author_email: jester@dltj.org
author_url: http://dltj.org/about
wordpress_id: 487
wordpress_url: http://dltj.org/?p=487
date: 2008-09-12 16:34:03 -0400
date_gmt: 2008-09-12 20:34:03 -0400
category: Campus Technology
categories:
- Textbooks
tags:
- Drupal
- textbook
- University System of Ohio
comments:
- id: 33835
  author: rob casson
  author_email: cassonrd@muohio.edu
  author_url: ''
  date: 2008-09-13 14:09:02 -0400
  date_gmt: 2008-09-13 18:09:02 -0400
  content: "excellent write-up, and particular thanks for the pointer to hook_search_page! \r\n\r\n i've been avoiding using some of the _search hooks, mainly b/c i couldn't figure out a proper way to control the display of search results...and of course, i must have skimmed over the relevant section in \"Pro Drupal Development\" too ;)"
- id: 33843
  author: the Jester
  author_email: jester@dltj.org
  author_url: http://dltj.org/about
  date: 2008-09-16 12:17:29 -0400
  date_gmt: 2008-09-16 16:17:29 -0400
  content: You're welcome, Rob.  I can't remember where I first ran across mention of hook_search_page.  I do know that it was out of <a href="http://drupal.org/node/286448" rel="nofollow">frustration</a> that <a href="http://api.drupal.org/api/function/hook_search_item/4.6" rel="nofollow">hook_search_item</a> was <a href="http://drupal.org/node/163046#comment-257318" rel="nofollow">removed</a>.  It has done the trick, though, for what I needed -- even if it did take more code than I though should be required.
- id: 33854
  author: Drupal as the Foundation of Ohio Textbook Portal | LISNews
  author_email: ''
  author_url: http://lisnews.org/node/31214/
  date: 2008-09-17 13:16:18 -0400
  date_gmt: 2008-09-17 17:16:18 -0400
  content: '<!--%kramer-ref-pre%-->[...] as the Foundation of Ohio Textbook Portal  Wed, 09/17/2008 - 08:17 &mdash; Blake  Disruptive Library Technology Jester: The textbook portal is based on the Drupal (version 6) content management system. In particular, [...]<!--%kramer-ref-post%-->'
- id: 33858
  author: 'The OPLIN 4cast &raquo; Blog Archive &raquo; OPLIN 4Cast #118: Amazon, Book logs, More from Google, Drupal'
  author_email: ''
  author_url: http://www.oplin.org/4cast/?p=226
  date: 2008-09-18 12:32:35 -0400
  date_gmt: 2008-09-18 16:32:35 -0400
  content: <!--%kramer-ref-pre%-->[...] Drupal as the Foundation of Ohio Textbook Portal [...]<!--%kramer-ref-post%-->
- id: 34175
  author: Tiffany
  author_email: tmille26@kent.edu
  author_url: ''
  date: 2008-11-01 14:49:43 -0400
  date_gmt: 2008-11-01 18:49:43 -0400
  content: I am a student at Kent State, and I have yet to be told about the Ohio Textbook Portal via our university communications.  That is disappointing, especially since I am in the instructional technology program.  You would think this would be something my department supported.
- id: 34211
  author: the Jester
  author_email: jester@dltj.org
  author_url: http://dltj.org/about
  date: 2008-11-03 10:19:49 -0500
  date_gmt: 2008-11-03 15:19:49 -0500
  content: Tiffany -- I certainly don't think it was the intention of the Board of Regents to keep this a secret.  There were perhaps some holes in the strategies to promote the portal.  I've forwarded your observations on to those that can do something with them.  (Me?  I just keep the technological end of it going...)
- id: 34370
  author: Sources | drupal.org
  author_email: ''
  author_url: http://drupal.org/aggregator/sources/
  date: 2008-12-13 16:52:38 -0500
  date_gmt: 2008-12-13 21:52:38 -0500
  content: <!--%kramer-ref-pre%-->[...] Library Technology Jester Drupal as the Foundation of Ohio Textbook Portal 13 weeks 1 day old [...]<!--%kramer-ref-post%-->
- id: 89046
  author: Jacob
  author_email: jacobdanes@gmail.com
  author_url: http://www.milblogging.com//profile.php?mode=viewp
  date: 2010-09-19 01:16:12 -0400
  date_gmt: 2010-09-19 05:16:12 -0400
  content: "Just wanted to shoot you a quick thanks.\r\n\r\nI've really been wrestling with drupal as of late and I've been looking for models to look over. Had no idea the Ohio TB portal was built on this.\r\n\r\nThis helped me alot.\r\nThanks a million!"
- id: 125559
  author: Kool Aid
  author_email: purplefilms@hotmail.com
  author_url: ''
  date: 2011-03-08 20:00:54 -0500
  date_gmt: 2011-03-09 01:00:54 -0500
  content: Well Drupal still confuses me a bit. Can't beat Wordpress and the ability to "look under the hood" and do some tweaking :) Anyway, the _search hooks are like anything riding a bicycle. Keep trying at it...
- id: 187143
  author: Drupal web sites with case studies | Listology
  author_email: ''
  author_url: http://www.listology.com/jwalling/list/drupal-web-sites-case-studies
  date: 2011-11-22 09:16:02 -0500
  date_gmt: 2011-11-22 14:16:02 -0500
  content: <!--%kramer-ref-pre%-->[...] Series | Ubercart http://drupal.org/node/933052http://textbooks.uso.edu/ Ohio Textbook Portal http://dltj.org/article/ohio-textbook-portal-design/http://themis.asu.edu/ Mars Odyssey Mission [...]<!--%kramer-ref-post%-->
- id: 570482
  author: "\u8ACB\u554F\u6709\u6C92\u6709\u985E\u4F3C\u7BA1\u7406\u96FB\u5B50\u66F8\u7684\u6A21\u7D44 \u5982Calibre | Drupal Taiwan \u6B63\u9AD4\u4E2D\u6587\u652F\u63F4\u7AD9"
  author_email: ''
  author_url: http://drupaltaiwan.org/forum/20130510/7298
  date: 2013-05-10 08:00:24 -0400
  date_gmt: 2013-05-10 12:00:24 -0400
  content: "<!--%kramer-ref-pre%-->[...] \u6211\u5728\u7DB2\u8DEF\u4E0A\u641C\u5C0B\u6709\u95DC Drupal\u7528\u4F86\u7BA1\u7406 \u96FB\u5B50\u66F8\u7684\u5957\u4EF6\uFF0C\u627E\u5230 \u9019\u500B\u7DB2\u9801\u6BD4\u8F03\u76F8\u95DC http://dltj.org/article/ohio-textbook-portal-design/ [...]<!--%kramer-ref-post%-->"
---
At the end of last month, the Ohio Board of Regents announced the University System of Ohio Textbook Portal. The service has been talked about in the [media](http://www.columbusdispatch.com/live/content/local_news/stories/2008/08/27/e-books.ART_ART_08-27-08_A1_U5B58IR.html?sid=101), in [trade publications](http://www.insidehighered.com/news/2008/08/26/etextbooks), and in [numerous](http://thecite.blogspot.com/2008/08/university-system-of-ohio-and.html) [blog](http://web.archive.org/web/20081211220047/http://www.ljndawson.com/permalink/2008/09/03/USO_and_CourseSmart.html) [postings](http://library.duke.edu/blogs/scholcomm/2008/08/29/state-of-play/). Enough time has passed now that word has gotten out, and I won't be taking any of the chancellor's thunder about the project. I did the back-end development work for the portal and wrote this document as an introduction to the project for our development team and anyone else interested about the project.

The textbook portal is based on the [Drupal](http://www.drupal.org/) ([version 6](http://api.drupal.org/api/6)) content management system. In particular, the portal makes heavy use of the [search module](http://api.drupal.org/api/file/modules/search/search.module/6) to execute and format search results. If you are familiar with Drupal, it is going to be different enough, however, that you're going to want to read this to see why some decisions were made. If you are not familiar with Drupal, this document will give you a head start into understanding the [Drupal way of the world](http://drupal.org/node/326).

A couple of points before we start. First, before starting this project I had only a passing familiarity with PHP as a programming language and no experience with code development for Drupal. ((These made seem like odd choices to make for a project that had a short conception-to-production timeline, but a) there were already some helpful pieces written in PHP that sped development of some aspects of the portal, and b) I thought [drinking the cool-aid](http://www.urbandictionary.com/define.php?term=drink+the+kool-aid) of Drupal would be a good way to see what it was all about.)) Read the code with that frame of mind; if you have more experience in either of these areas and know of a better way to do something, please let me know and I will gratefully incorporate your suggestions into the code. Second, you can find the code in OhioLINK's public Subversion repository and reference to it in OhioLINK's public Trac project server, should you want to take a look at it yourself.

This code in the Subversion repository corresponds to everything under the `/sites` directory of a Drupal installation. In the basic Drupal installation, there are two subdirectories in this directory: `all` and `default`. In a multi-site Drupal installation, the "all" directory is supposed to correspond to modules/themes that are made available to all sites within an installation while the "default" directory is intended for modules/themes for the "[default site](http://drupal.org/node/53705)". I'm using the distinction somewhat differently. Everything in the "all" directory is third-party modules and everything in the "default" directory is stuff I've created. It is an arbitrary, unnecessary distinction, but I think it will help with maintenance.

At a very high level, you can look at the Installation Documentation for the ETextbook Portal. This document was written from the perspective of a bare metal restore of the service. (Well, not quite -- it assumes Ubuntu is installed on the server.) It has the various applications and modules that need to be installed to get the site up and running. This should make a good checklist should you wish to reproduce the portal. Knowing how to [install Drupal](http://drupal.org/getting-started) comes in handy, but the installation process itself it pretty easy.

If you follow the documentation up to the point of restoring the database, you'll have a good foundation. But doing so will mean that there are several configuration options you'll need to set that would otherwise be in the database backup. You'll need to activate these modules:

eTextbook Metasearch
    Integrates the results from the various textbook search modules. This corresponds to the Drupal node type "all".
CourseSmart Search
    Searches the CourseSmart eTextbook Database. This corresponds to the Drupal node type "csmart".
OhioLINK E-Books Search
    Searches the OhioLINK E-book Center. This corresponds to the Drupal node type "ebooks".
OhioLINK Library Catalog Search
    Searches the OhioLINK Central Catalog. This corresponds to the Drupal node type "libcat".
Safari Search
    Searches Safari Books Online. This corresponds to the Drupal node type "safari".

Each of them has minor, but important, configuration parameters that you'll need to set up in the Drupal installation's `/admin/settings` directory. In particular, the CourseSmart Search module will have parameters for the discount coupon code plus the username/password for the private API (the private API is discussed in the module-specific section below).

## Structure of the Search Modules

Each of the search modules -- CourseSmart, OhioLINK EBC, OhioLINK Library Catalog, and Safari -- follow the same basic structure. (The "all" metasearch module is a little different and is covered below.) The outline, hooks followed by supporting functions, is:

```php
function module_menu() {
  ...
}


function module_perm() {
  ...
}


function module_search($op = 'search', $keys = NULL) {
  ...
}


function module_form_alter(&$form, $form_state, $form_id) {
  ...
}


function module_search_process($keys) {
  ...
}


function module_format_result($item) {
  ...
}


function module_search_box_form_submit($form, &$form_state) {
  ...
}


function module_search_query($keys = '', $query = array(), $search = 'web', $version = 'v1') {
  ...
}
```

Some explanation for each of these:

  * `_module__menu()` is a [Drupal hook that defines the menu options](http://api.drupal.org/api/function/hook_menu/6) for the setting screen. The code to generate the menus themselves will be in a file in the module called "_module_.admin.inc".
  * `_module__perm()` is a [Drupal hook for defining the user permissions](http://api.drupal.org/api/function/hook_perm/6)appropriate for this module. It isn't really used in the portal. (The settings screens look for the "administer site configuration" user permission value.)
  * `_module__search()` is a [Drupal hook that defines a custom search routine](http://api.drupal.org/api/function/hook_search/6) for nodes of this type. The code pattern in other Drupal modules seems to be to use this as a level of indirection to a non-hook function, such as `_module__search_process()`.
  * `_module__form_alter()` is a [Drupal hook for changing the behavior of a form](http://api.drupal.org/api/function/hook_form_alter/6)before it is rendered in the HTML back to the user. In conjunction with `_module__search_box_form_submit()`, the code in this hook will turn FORM POST requests into pretty URLs.
  * `_module__search_process()` is the function called by the `_module__search()`function. This function prepares the query, including the pagination-of-results calculation, and calls another function -- `_module__search_query()` -- to do the actual searching. We're adding this level of indirection because the "metasearch" module will also call `_module__search_query()` to get results, but the code in that module does do all of the things `_module__search_process()` does.
  * `_module__format_result()` is called with information about the search hit, and formats it in a way that can be fed back into the Drupal search.module output engine. The issue here is that we've got fielded data (author, copyright year, publisher, and ISBN) that we want to display as fielded, but Drupal doesn't give us a way to do that. Rather, Drupal's standard search module is looking for an array with keys for 'title' of the hit, 'link' of the hit, and a 'snippet' to display to give the user context for the result. (See the "Return Value" heading of the [hook_search API documentation](http://api.drupal.org/api/function/hook_search/6).) So this module will create a snippet of HTML that builds a nice display of the fielded data.
  * `_module__search_box_form_submit()`, in conjunction with `_module__form_alter()`, forms the callback to turn FORM POST requests into pretty URLs.
  * `_module__search_query()` performs whatever functions are required to get hits from the remote service. This, of course, is the real heart of what we're doing. Rather than searching text of nodes internal to Drupal, this function will return an array of results that comes from a query of a remote service. The array returned has two elements: 'total' -- an integer representing the total number of hits for the query, and 'items' -- an array of individual hits from this search.

## Module-specific details

Although each of the search modules follows this general code pattern, they each have their idiosyncrasies.

**CourseSmart** is probably the simplest module of the bunch and a good place to start when looking at the code. Note that we are using the private API (appending `md=1` to the end of the URL) in order to get the ISBNs as listed on the CourseSmart website. Calls to the private API is restricted to particular IP addresses, so in order to use it you'll need to contact CourseSmart. CourseSmart is also a little funky in that they will return items in their inventory that they won't sell. This is designated with an esubscription price of $0, and are filtered out in the `_module__search_process()` function.

**OhioLINK EBook Center** uses the [SRU interface to the underlying XTF installation](http://xtf.wiki.sourceforge.net/experimental_SRU_Servlet) in order to get search results out. The search results come back in an XML document returned with multiple namespaces, which complicates somewhat the DOM parsing of that document. Basically, it means one has to register the namespaces with the XPath processor and take them into account when using XPath to pull out elements for formatting the result record.

**OhioLINK Library Catalog** uses the [Shrew PHP class](http://code.google.com/p/shrew/) created by David Walker at California State University. Shrew hacks through the MARC display of records for an Innovative Interfaces WebPAC and returns a [MARCXML](http://www.loc.gov/standards/marcxml/)document. Without this, I'd really be stuck as to how to efficiently get the library catalog search results into the portal. I'm grateful to him for releasing the code at exactly the right time and to Rob Casson at Miami who pointed me in David's direction when I was considering having to write the Shrew-equivalent myself.

**Safari Books Online** is using the same underlying engine as CourseSmart to deliver materials, so the search module is very similar.

## Structure of the Metasearch Module

The eTextbook Metasearch module (a.k.a. "all") is structured very similar to the other search modules, but deviates in several important ways.

  * When the Drupal `all_search` hook is called with the 'search' operation parameter, a results array with explicitly 1 "result" and the search keys as the item returned. What we're really doing is faking out the Drupal Search module into thinking that there are actually results so we can get to the `all_search_page()` hook. If we didn't set the number of results to a value greater than zero, Drupal would display the "no hits found" message for us (which we don't want it to do).
  * The [undocumented](http://drupal.org/node/185469) `hook_search_page()`, when defined for a module, is called by Drupal rather than using the built-in internal search results page. (The other modules use the built-in results page rendering.) We override the hook using `all_search_page()`, and that function calls each of the `_module__search_query()` functions for the four remote sources in sequence. The results are then put into output block and the block is returned to the calling core code.
  * "all" also contains several utility functions used by the other modules.`all_parse_keys()` will look at the user's search string for ISBN values and return the user's search string as an array of an ISBN and everything else. `all_proxyify_url()` will determine whether a user is outside of a campus network and prepend the OhioLINK proxy server string to the URL.

## Plans for Enhancements

Some ideas and plans for making this better.

  * We want to include bookstores in the search results. In particular, where possible, we'd like to search the bookstore's inventory control system and display results right in the metasearch results.
  * For the metasearch results, each of the target remote services are called in sequence. Ideally, the four services would be called in parallel. Even better, perhaps, would be to render the base page, then inject search results from the remote services via AJAX as they become available.

The text was modified to remove a link to http://drc-dev.ohiolink.edu/browser/eTextbookPortal/etextbook-installation.html?rev=1042 on January 13th, 2011.

The text was modified to remove a link to http://drc-dev.ohiolink.edu/browser/eTextbookPortal/ on January 13th, 2011.

The text was modified to remove a link to https://drc-dev.ohiolink.edu/browser/eTextbookPortal/default/modules/all/all.module?rev=1042#L173 on January 13th, 2011.

The text was modified to remove a link to https://drc-dev.ohiolink.edu/browser/eTextbookPortal/default/modules/all/all.module?rev=1042#L61 on January 13th, 2011.

The text was modified to remove a link to http://drc-dev.ohiolink.edu/browser/eTextbookPortal/default/modules/ebooks/ebooks.module?rev=1042#L137 on January 13th, 2011.

The text was modified to remove a link to http://drc-dev.ohiolink.edu/browser/eTextbookPortal/default/modules/ebooks/ebooks.module?rev=1042#L130 on January 13th, 2011.

The text was modified to remove a link to http://drc-dev.ohiolink.edu/browser/eTextbookPortal/default/modules/csmart/csmart.module?rev=1042#L101 on January 13th, 2011.

The text was modified to remove a link to http://drc-dev.ohiolink.edu/browser/eTextbookPortal/default/modules/libcat?rev=1042 on January 13th, 2011.

The text was modified to remove a link to http://drc-dev.ohiolink.edu/browser/eTextbookPortal/default/modules/ebooks?rev=1042 on January 13th, 2011.

The text was modified to remove a link to http://drc-dev.ohiolink.edu/browser/eTextbookPortal/default/modules/csmart?rev=1042 on January 13th, 2011.

The text was modified to remove a link to http://drc-dev.ohiolink.edu/browser/eTextbookPortal/default/modules/all?rev=1042 on January 13th, 2011.

The text was modified to remove a link to https://drc-dev.ohiolink.edu/browser/eTextbookPortal/default/modules/all/all.module?rev=1042#L206 on January 13th, 2011.

The text was modified to remove a link to http://drc-dev.ohiolink.edu/browser/eTextbookPortal/default/modules/safari?rev=1042 on January 13th, 2011.

The text was modified to update a link from http://drupal.org/getting-started/6 to http://drupal.org/getting-started on January 28th, 2011.

The text was modified to remove a link to http://uso.edu/newsUpdates/media/releases/2008/08/MediaRel_27Aug08.php on November 13th, 2012.

The text was modified to remove a link to http://textbooks.uso.edu/ on November 13th, 2012.

The text was modified to update a link from http://www.ljndawson.com/permalink/2008/09/03/USO_and_CourseSmart.html to http://web.archive.org/web/20081211220047/http://www.ljndawson.com/permalink/2008/09/03/USO_and_CourseSmart.html on November 13th, 2012.
